---
- name: features | Installing AD Domain Services
  win_feature: 
    name: 
      - RSAT-AD-AdminCenter
      - AD-Domain-Services
      - DNS
    include_management_tools: yes
    include_sub_features: yes
    state: present
  register: feature_check

- name: Reboot to complete feature setup (as required)
  win_reboot:
    pre_reboot_delay: 120
    reboot_timeout: 600
    post_reboot_delay: 120
  when: feature_check.reboot_required

- name: Check for xDnsServer Powershell module
  win_psmodule:
    name: xDnsServer
    state: present

- name: Configure DNS Forwarders
  win_dsc:
    resource_name: xDnsServerSetting
    Name: DNSServerProperties
    NoRecursion: false
    Forwarders: "{{ windows_domain_info['dns_forward_lookup'] }}"

- name: Set DNS server
  win_dns_client:
    adapter_names: "*"
    ipv4_addresses: "127.0.0.1"

# Provision forest using DSC
- name: Add xActiveDirectory
  win_psmodule:
    name: xActiveDirectory
    state: present

- name: Configure xADDomain Powershell DSC
  win_dsc:
    resource_name: xADDomain
    DomainName: "{{ windows_domain_controller_info['dns_domain_name'] }}"
    DomainAdministratorCredential_username: "{{ windows_domain_controller_info['domain_admin_user'] }}"
    DomainAdministratorCredential_password: "{{ windows_domain_controller_info['domain_admin_password'] }}"
    SafemodeAdministratorPassword_username: "{{ windows_domain_controller_info['safe_mode_username'] }}"
    SafemodeAdministratorPassword_password: "{{ windows_domain_controller_info['safe_mode_password'] }}"

- name: Wait for forest xWaitForADDomain
  win_dsc:
    resource_name: xWaitForADDomain
    DomainName: "{{ windows_domain_controller_info['dns_domain_name'] }}"
    DomainUserCredential_username: "{{ windows_domain_controller_info['domain_admin_user'] }}"
    DomainUserCredential_password: "{{ windows_domain_controller_info['domain_admin_password'] }}"
    RetryCount: 100
    RetryIntervalSec: 5

- name: Reboot to complete domain controller setup (as required)
  win_reboot:
    pre_reboot_delay: 120
    reboot_timeout: 600
    post_reboot_delay: 120 # your mileage may vary

- name: Wait for domain fqdn resolution
  win_shell: |
    start-sleep -Seconds 5
    while($true){
      try {
          [Net.DNS]::GetHostEntry("{{ windows_domain_controller_info['dns_domain_name'] }}")
          write-output "DNS Resolution Success"
          break;
      }catch{
          write-output "DNS Resolution Failure"
      }
      start-sleep -Seconds 5
    }
  async: 900
  poll: 5
  register: async_out

- name: 'DNS - check on async task'
  async_status:
    jid: "{{ async_out.ansible_job_id }}"
  register: job_result
  until: job_result.finished
  retries: 30